<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wimoor.amazon.inbound.mapper.ShipInboundItemMapper">
	<resultMap id="BaseResultMap" type="com.wimoor.amazon.inbound.pojo.entity.ShipInboundItem">
		<id column="id" property="id" jdbcType="CHAR" />
		<result column="ShipmentId" property="shipmentid" jdbcType="CHAR" />
		<result column="SellerSKU" property="sellersku" jdbcType="CHAR" />
		<result column="inboundplanid" property="inboundplanid" jdbcType="CHAR" />
		<result column="FulfillmentNetworkSKU" property="fulfillmentnetworksku" jdbcType="CHAR" />
		<result column="Quantity" property="quantity" jdbcType="INTEGER" />
		<result column="QuantityShipped" property="quantityshipped" jdbcType="INTEGER" />
		<result column="QuantityReceived" property="quantityreceived" jdbcType="INTEGER" />
		<result column="QuantityInCase" property="quantityincase" jdbcType="INTEGER" />
	</resultMap>
	<sql id="Base_Column_List">
		ShipmentId, SellerSKU, FulfillmentNetworkSKU, Quantity, QuantityShipped,
		QuantityReceived, QuantityInCase,inboundplanid
	</sql>

	<select id="findMaterielByShipPlanId" resultType="java.util.Map" parameterType="java.lang.String">
		select tb.marketplaceid,tb.amazongroupid,tb.warehouseid,tm.id materialid,pf.sku,opt.msku
		from t_erp_ship_inboundplan tb
		left join t_product_info pf on pf.sku = #{sku,jdbcType=CHAR} and pf.marketplaceid = tb.marketplaceid
		left join t_amazon_auth auth on auth.id=pf.amazonAuthId
		left join t_product_in_opt opt on opt.pid = pf.id
		left join t_erp_material tm on tm.sku = ifnull(opt.msku,pf.sku) and tm.shopid=tb.shopid and tm.isDelete = 0
		where auth.groupid=tb.amazongroupid and tb.id = #{id,jdbcType=CHAR}
	</select>

	<select  id="refreshOutbound" resultType="java.lang.Integer" parameterType="java.lang.String">
		select (SELECT ifnull(SUM(IFNULL(i.QuantityShipped,i.Quantity)),0) qty FROM t_erp_ship_inbounditem i
		LEFT JOIN t_erp_ship_inboundshipment s  ON s.ShipmentId=i.ShipmentId
		LEFT JOIN  t_erp_ship_v2_inboundshipment v2 on v2.shipment_confirmation_id=s.ShipmentId
		LEFT JOIN t_erp_ship_inboundplan p ON p.id=s.inboundplanid AND p.id=i.inboundplanid
		WHERE s.`status`>=2 AND s.`status` &lt;=4 AND i.msku=#{msku,jdbcType=CHAR}
		AND p.auditstatus=3 and v2.shipmentid is null
		AND p.shopid=#{shopid,jdbcType=CHAR} AND p.warehouseid=#{warehouseid,jdbcType=CHAR}) +
		(SELECT ifnull(SUM(IFNULL(i2.confirm_quantity,i2.quantity)),0) FROM t_erp_ship_v2_inbounditem i2
		LEFT JOIN t_erp_ship_v2_inboundplan f ON f.id=i2.formid
		WHERE f.auditstatus>=2 AND f.auditstatus &lt;=7 AND i2.msku=#{msku,jdbcType=CHAR}
		AND f.shopid=#{shopid,jdbcType=CHAR} AND f.warehouseid=#{warehouseid,jdbcType=CHAR} )
	</select>
	
	<select id="selectByShipmentid" resultType="java.util.Map" parameterType="java.lang.String">
	select distinct 
		    item.id, 
		    item.ShipmentId shipmentid,
		    item.ShipmentId ShipmentId,
		    item.SellerSKU sellersku,
		    item.SellerSKU SellerSKU,
		    item.FulfillmentNetworkSKU fulfillmentnetworksku,
		    item.totaltransfee,
		    item.unittransfee,
		    item.totalcost,
		    item.unitcost,
		 	item.PrepOwner,
			item.PrepInstruction,
			item.PrepOwner prepowner,
			item.PrepInstruction prepinstruction,
		    item.FulfillmentNetworkSKU FNSKU ,
		    ifnull(p.msku,item.SellerSKU) sku,
		    ifnull(p.msku,item.SellerSKU) msku,
		    (select  GROUP_CONCAT(c.name) from t_product_category c where c.pid=p.id )  typename,
		    ifnull(item.Quantity,0) quantity,
		    ifnull(item.Quantity,0) Quantity,
			ifnull(ifnull(item.QuantityShipped,item.Quantity),0) quantityshipped,
			ifnull(ifnull(item.QuantityShipped,item.Quantity),0) QuantityShipped,
			ifnull(item.QuantityReceived,0) quantityreceived, 
			p.name pname,
			p.id pid,
			plan.marketplaceid marketplaceid,
			ifnull(pt2.location,pt2.url) image,
			m.color mcolor,
			ifnull((select sum(iv2.quantity) 
					from t_erp_inventory iv2 
					where iv2.materialid=m.id
						and iv2.warehouseid=plan.warehouseid
						and iv2.status like 'outbound_%'),0) invquantity_outbound,
			ifnull(item.materialid,m.id) mid,
			ifnull(item.materialid,m.id) materialid,
			item.QuantityReceived,
			item.QuantityReceived quantityreceived,
			item.QuantityInCase,
			item.QuantityInCase	quantityincase,
			p.asin,
			p.name,
			m.name ,
		    m.color mcolor,
		    m.issfg, 
		    m.boxnum,
		    d.length boxlength,
            d.width boxwidth,
            d.height boxheight,
            d.weight boxweight,
            case when ifnull(d.width,0) > 0 and ifnull(d.height,0) > 0 and ifnull(d.length,0) > 0
							then  (d.width*d.height*d.length)/1000000 else 0 end boxvolume,
							ifnull(dim.weight,0) weight,
            ifnull(ifnull(item.QuantityShipped,item.Quantity),0)*ifnull(m.price,0) price,
            ROUND(ifnull(dim.length,0)*ifnull(dim.width,0)*ifnull(dim.height,0)/ifnull(de.drate,5000.0),2) dimweight,
						    case when ifnull(dim.width,0) > 0 and ifnull(dim.height,0) > 0 and ifnull(dim.length,0) > 0
							then  ROUND(ifnull(ifnull(item.QuantityShipped,item.Quantity),0)*(dim.width*dim.height*dim.length)/1000000.0,2) 
							else 0 end volume,
		   
		    ifnull(
				            (select sum(iv.quantity) from t_erp_inventory iv 
                              where 
                               iv.materialid=ifnull(item.materialid,m.id) 
                               and iv.warehouseid=plan.warehouseid 
                               and iv.`status`='fulfillable'
				             )
			  ,0) invquantity
		from t_erp_ship_inbounditem item
		left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
		left join t_erp_ship_inboundtrans tr on tr.shipmentid=item.shipmentid
		left join t_erp_ship_transdetail de on de.company=tr.company and de.id=tr.channel
		left join(select 
		            v.sku,v.marketplaceid,auth.groupid,
		            max(v.id) id,
		            max(v.asin) asin,
		            max(v.name) name,
		            ifnull(max(opt.msku),max(v.sku)) msku,
		            max(v.image) image
					from t_product_info v
					left join t_product_in_opt opt on opt.pid = v.id
					left join t_amazon_auth auth on auth.id=v.amazonAuthId
					left join t_erp_ship_inboundplan p on p.amazongroupid=auth.groupid and p.marketplaceid=v.marketplaceid
					left join t_erp_ship_inbounditem i on i.inboundplanid=p.id
					where i. ShipmentId =#{shipmentid,jdbcType=CHAR} and i.SellerSKU=v.sku 
					group by v.sku,v.marketplaceid,auth.groupid
		) p on p.sku=item.SellerSKU and p.marketplaceid=plan.marketplaceid and p.groupid=plan.amazongroupid
		left join t_erp_material m on m.sku = ifnull(p.msku,item.SellerSKU) and plan.shopid=m.shopid and m.isDelete = 0
		left join t_dimensions d on d.id=m.boxDimensions
		left join t_dimensions dim on dim.id=m.pkgDimensions
		left join t_picture pt2 on pt2.id=p.image
		where item.ShipmentId = #{shipmentid,jdbcType=CHAR}
		order by item.SellerSKU
	</select>
	
	<select id="selectByInboundplanid" resultType="java.util.Map" parameterType="java.lang.String">
	 SELECT  
			v.SellerSKU,
			v.fulfillmentnetworksku,
			v.sku,
			v.msku,
			v.Quantity,
			v.QuantityShipped,
			v.pname,
				ifnull(pt.location,ifnull(pt2.location,pt2.url)) image,
			v.drate,
			ifnull(v.materialid,m.id) materialid,
			v.QuantityReceived,
			v.QuantityInCase,
			v.warehouseid,
			v.shopid,
			v.groupid,
			v.marketplaceid,
			v.pid,
			v.asin,
			v.name pname,
			m.name name,
				        (select  GROUP_CONCAT(c.name) from t_product_category c where c.pid=v.pid )  typename,
					    m.color mcolor,
					    m.issfg, 
					    m.boxnum,
					    ifnull(v.materialid,m.id) mid,
					 	 ifnull(v.materialid,m.id) materialid,
					    d.length boxlength,
			            d.width boxwidth,
			            d.height boxheight,
			            d.weight boxweight,
			           ifnull((select sum(iv2.quantity) 
								from t_erp_inventory iv2 
								where iv2.materialid=m.id
									and iv2.warehouseid=v.warehouseid
									and iv2.status like 'outbound_%'),0) invquantity_outbound,
			            case when ifnull(d.width,0) > 0 and ifnull(d.height,0) > 0 and ifnull(d.length,0) > 0
										then  (d.width*d.height*d.length)/1000000 else 0 end boxvolume,
										ifnull(dim.weight,0) weight,
			            ifnull(ifnull(v.QuantityShipped,v.Quantity),0)*ifnull(m.price,0) price,
			            ROUND(ifnull(dim.length,0)*ifnull(dim.width,0)*ifnull(dim.height,0)/ifnull(v.drate,5000.0),2) dimweight,
									    case when ifnull(dim.width,0) > 0 and ifnull(dim.height,0) > 0 and ifnull(dim.length,0) > 0
										then  ROUND(ifnull(ifnull(v.QuantityShipped,v.Quantity),0)*(dim.width*dim.height*dim.length)/1000000.0,2) 
										else 0 end volume,
					   
					    ifnull(
							            (select sum(iv.quantity) from t_erp_inventory iv 
			                              where 
			                               iv.materialid=ifnull(v.materialid,m.id) 
			                               and iv.warehouseid=v.warehouseid 
			                               and iv.`status`='fulfillable'
							             )
						  ,0) invquantity
						  from (
				select   
					    max(item.SellerSKU) SellerSKU,
					    max(item.FulfillmentNetworkSKU) fulfillmentnetworksku,
					    max(ifnull(p.msku,item.SellerSKU)) sku,
					    ifnull(max(p.msku),max(item.SellerSKU)) msku,
					   sum(ifnull(item.Quantity,0)) Quantity,
						sum(ifnull(ifnull(item.QuantityShipped,item.Quantity),0)) QuantityShipped,
						max(p.name) pname,
						max(p.image) image,
					   max(drate) drate,
				      MAX(item.materialid) materialid,
						sum(item.QuantityReceived) QuantityReceived,
						sum(item.QuantityInCase) QuantityInCase,
						MAX(plan.warehouseid) warehouseid,
						MAX(plan.shopid) shopid,
						MAX(plan.amazongroupid) groupid,
						MAX(plan.marketplaceid) marketplaceid,
					   MAX(p.id) pid,
						max(p.asin) asin,
						max(p.name) name 
					from t_erp_ship_inbounditem item
					left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
					left join t_erp_ship_inboundtrans tr on tr.shipmentid=item.shipmentid
					left join t_erp_ship_transdetail de on de.company=tr.company and de.id=tr.channel
					left join(select 
					            v.sku,v.marketplaceid,auth.groupid,
					            max(v.id) id,
					            max(v.asin) asin,
					            max(v.name) name,
					            ifnull(max(opt.msku),max(v.sku)) msku,
					            max(v.image) image
								from t_product_info v
								left join t_product_in_opt opt on opt.pid = v.id
								left join t_amazon_auth auth on auth.id=v.amazonAuthId
								left join t_erp_ship_inboundplan p on p.amazongroupid=auth.groupid and p.marketplaceid=v.marketplaceid
								left join t_erp_ship_inbounditem i on i.inboundplanid=p.id
								where p.id =#{inboundplanid,jdbcType=CHAR} and i.SellerSKU=v.sku 
								group by v.sku,v.marketplaceid,auth.groupid
					  ) p on p.sku=item.SellerSKU and p.marketplaceid=plan.marketplaceid and p.groupid=plan.amazongroupid
					  where item.inboundplanid = #{inboundplanid,jdbcType=CHAR}
					group by  item.SellerSKU
					) v
					left join t_erp_material m on m.sku = v.msku and v.shopid=m.shopid and m.isDelete = 0
					left join t_dimensions d on d.id=m.boxDimensions
					left join t_dimensions dim on dim.id=m.pkgDimensions
					left join t_picture pt on m.image=pt.id
					left join t_picture pt2 on pt2.id=v.image
				 
		  
		 
		
	</select>
	
		<select id="getOneByShipmentid" resultType="com.wimoor.amazon.inbound.pojo.entity.ShipInboundItem" parameterType="java.lang.String">
		select distinct item.ShipmentId, item.SellerSKU, item.FulfillmentNetworkSKU, item.Quantity, item.QuantityShipped,
		item.QuantityReceived, item.QuantityInCase,item.inboundplanid,ifnull(item.msku,p.msku) msku,item.materialid,
		item.PrepInstruction,item.PrepOwner
		from t_erp_ship_inbounditem item
		left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
		left join(select auth.groupid groupid,v.*, ifnull(opt.msku,v.sku) msku
					from t_product_info v
					left join t_product_in_opt opt on opt.pid = v.id
					left join t_amazon_auth auth on auth.id=v.amazonAuthId
		) p on p.sku=item.SellerSKU and p.marketplaceid=plan.marketplaceid and p.groupid=plan.amazongroupid
		where ShipmentId = #{shipmentid,jdbcType=CHAR}
	</select>
	
    <select id="summaryShipmentItem"  resultType="com.wimoor.amazon.inbound.pojo.vo.ShipInboundShipmenSummarytVo"   parameterType="java.lang.String">
         select max(item.ShipmentId) ShipmentId,
                count(item.SellerSKU) skuamount,
                max(inbound.status2date) auditime,
				sum(ifnull(item.QuantityShipped,0)) sumQuantity,
				max(date_format(plan.createdate, '%Y-%m-%d')) createdate,
				max(w.name) warehouse ,
				max(ag.name) groupname , 
				max(plan.warehouseid) warehouseid,
				max(plan.shopid) shopid,
				max(m.name) country ,
				max(inbound.DestinationFulfillmentCenterId) center,
				max(ifnull(inbound.remark,plan.remark)) remark ,
				max(inbound.check_inv) checkinv
			from t_erp_ship_inbounditem item
			left join t_erp_ship_inboundshipment inbound on inbound.ShipmentId=item.ShipmentId
			left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
			left join t_erp_warehouse w on w.id = plan.warehouseid
			left join t_amazon_group ag on ag.id=plan.amazongroupid
			left join t_marketplace m on m.marketplaceId=plan.marketplaceid
			where item.ShipmentId = #{shipmentid,jdbcType=CHAR}
    </select>
    
    <select id="summaryShipmentsItem"  resultType="com.wimoor.amazon.inbound.pojo.vo.ShipInboundShipmenSummarytVo"   parameterType="java.util.List">
         select max(item.ShipmentId) ShipmentId,
                count(item.SellerSKU) skuamount,
                max(inbound.status2date) auditime,
				sum(ifnull(item.QuantityShipped,0)) sumQuantity,
				max(date_format(plan.createdate, '%Y-%m-%d')) createdate,
				max(w.name) warehouse ,
				max(ag.name) groupname , 
				max(plan.warehouseid) warehouseid,
				max(plan.shopid) shopid,
				max(m.name) country ,
				max(inbound.DestinationFulfillmentCenterId) center,
				max(ifnull(inbound.remark,plan.remark)) remark ,
				GROUP_CONCAT(distinct inbound.check_inv) checkinv
			from t_erp_ship_inbounditem item
			left join t_erp_ship_inboundshipment inbound on inbound.ShipmentId=item.ShipmentId
			left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
			left join t_erp_warehouse w on w.id = plan.warehouseid
			left join t_amazon_group ag on ag.id=plan.amazongroupid
			left join t_marketplace m on m.marketplaceId=plan.marketplaceid
			where item.ShipmentId  in (
			    <foreach collection="list" item="shipmentid" index="field_list" open="" separator="," close="">
			                #{shipmentid,jdbcType=CHAR}
		        </foreach>
		       )
			
    </select>
    
    
    <select id="summaryShipmentSku"  resultType="java.lang.Integer"   parameterType="java.lang.String">
         select   
            sum(case when 
                      (ifnull(item.QuantityShipped,0)-ifnull(item.QuantityReceived,0))>=0 
                 then ifnull(item.QuantityShipped,0)-ifnull(item.QuantityReceived,0)
                 else 0 end 
            ) quantity
			from t_erp_ship_inbounditem item
			left join t_erp_ship_inboundshipment inbound on inbound.ShipmentId=item.ShipmentId
			left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
			left join t_erp_warehouse w on w.id = plan.warehouseid
			left join t_amazon_group ag on ag.id=plan.amazongroupid
			left join t_marketplace m on m.marketplaceId=plan.marketplaceid
			where item.SellerSKU = #{sku,jdbcType=CHAR}
			<if test="marketplaceid=='EU'">
			   and m.region='EU'
			</if>
			<if test="marketplaceid!='EU'">
			   	and plan.marketplaceid= #{marketplaceid,jdbcType=CHAR}
			</if>
			and plan.createdate>ADDDATE(NOW(), INTERVAL -1 year)
			and plan.amazongroupid= #{groupid,jdbcType=CHAR}
			and inbound.status>=2 and inbound.status &lt;6
    </select>
    
	<select id="selectObjByShipmentid" resultType="com.wimoor.amazon.inbound.pojo.vo.ShipInboundItemVo"  parameterType="java.lang.String">
			select distinct item.id, 
			                item.ShipmentId,
			                ifnull(opt.msku,item.SellerSKU) sku,
			                ifnull(opt.msku,item.SellerSKU) msku,
			                (select  GROUP_CONCAT(c.name) from t_product_category c where c.pid=info.id )  typename,
			                ifnull(item.Quantity,0) Quantity,
				            ifnull(ifnull(item.QuantityShipped,item.Quantity),0) QuantityShipped,
				            ifnull(item.QuantityReceived,0) QuantityReceived, 
				            m.name ,
				            ifnull(pt.location,ifnull(pt2.location,pt2.url)) image,
				            m.color mcolor,
				            m.issfg, 
				            ifnull(
				            (select sum(iv.quantity) from t_erp_inventory iv 
                              where 
                               iv.materialid=ifnull(item.materialid,m.id) 
                               and iv.warehouseid=plan.warehouseid 
                               and iv.`status`='fulfillable'
				             )
				            ,0) invquantity,
							ifnull(
							( select sum(iv2.quantity) from 
							    t_erp_inventory iv2 where iv2.materialid=m.id
								and iv2.warehouseid=plan.warehouseid and iv2.status like 'outbound_%'
							),0) outbound,
				            ifnull(item.materialid,m.id) materialid,
				            item.QuantityReceived,
				            item.FulfillmentNetworkSKU,
				            item.SellerSKU sellersku,
				            item.FulfillmentNetworkSKU FNSKU ,
				            info.asin,info.name pname,
				            m.boxnum,
				            d.length boxlength,
				            d.width boxwidth,
				            d.height boxheight,
				            d.weight boxweight,
				            dim.length pkglength,
				            dim.width  pkgwidth,
				            dim.height pkgheight,
				            dim.weight pkgweight,
				            ifnull(ifnull(item.QuantityShipped,item.Quantity),0)*ifnull(m.price,0) price,
				            od.avgsales,
							case when ifnull(d.width,0) > 0 and ifnull(d.height,0) > 0 and ifnull(d.length,0) > 0
							then  (d.width*d.height*d.length)/1000000 else 0 end boxvolume,
							ifnull(dim.weight,0) weight,
			                ROUND(ifnull(dim.length,0)*ifnull(dim.width,0)*ifnull(dim.height,0)/ifnull(de.drate,6000.0),2) dimweight,
						    case when ifnull(dim.width,0) > 0 and ifnull(dim.height,0) > 0 and ifnull(dim.length,0) > 0
							then  ROUND(ifnull(ifnull(item.QuantityShipped,item.Quantity),0)*(dim.width*dim.height*dim.length)/1000000.0,2) 
							else 0 end volume,
							(dim.width*dim.height*dim.length)/1000000.0 skuvolume,
							item.totaltransfee,item.unittransfee,item.totalcost,item.unitcost,
							item.PrepOwner,
							item.PrepInstruction
			from t_erp_ship_inbounditem item
			left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
			left join t_marketplace mk on mk.marketplaceid =plan.marketplaceid
			left join t_amazon_auth auth on auth.groupid=plan.amazongroupid and auth.aws_region=mk.aws_region
			left join t_product_info info on info.marketplaceid=mk.marketplaceid and info.sku=item.SellerSKU and info.amazonauthid=auth.id
			left join t_product_in_opt opt on opt.pid=info.id
			left join t_product_in_order od on od.pid=info.id
			left join t_erp_ship_inboundtrans tr on tr.shipmentid=item.shipmentid
			left join t_erp_ship_transdetail de on de.company=tr.company and de.id=tr.channel
			left join t_erp_material m on m.sku =ifnull(opt.msku,info.sku) and plan.shopid=m.shopid and m.isDelete = 0
			left join t_dimensions d on d.id=m.boxDimensions
			left join t_dimensions dim on dim.id=m.pkgDimensions
			left join t_picture pt on m.image=pt.id
			left join t_picture pt2 on pt2.id=info.image
			where item.ShipmentId = #{shipmentid,jdbcType=CHAR} 
			order by item.sellersku
	</select>

<select id="selectObjByShipmentsid" resultType="com.wimoor.amazon.inbound.pojo.vo.ShipInboundItemVo"  parameterType="java.util.List">
			select          m.name ,
			                d.length boxlength,
				            d.width  boxwidth,
				            d.height boxheight,
				            d.weight boxweight,
				            m.color mcolor,
				            m.boxnum,
				            m.issfg, 
				             ifnull(
				            (select sum(iv.quantity) from t_erp_inventory iv 
                              where  iv.materialid=m.id
                                 and iv.warehouseid=v.warehouseid 
                                 and iv.`status`='fulfillable'
				             )
				            ,0) invquantity,
				            
							ifnull(
							( select sum(iv2.quantity) from   t_erp_inventory iv2 
							    where iv2.materialid=m.id
								  and iv2.warehouseid=v.warehouseid 
								  and iv2.status like 'outbound_%'
							),0) outbound,
							v.*
			from (
					select  
					        GROUP_CONCAT(s.check_inv) id,        
			                max(ifnull(opt.msku,item.SellerSKU)) msku,
			                sum(ifnull(item.Quantity,0)) Quantity,
				            sum(ifnull(ifnull(item.QuantityShipped,item.Quantity),0)) QuantityShipped,
				            sum(ifnull(item.QuantityReceived,0)) QuantityReceived, 
				            max(ifnull(pt2.location,pt2.url)) image,
				            max(item.FulfillmentNetworkSKU) FulfillmentNetworkSKU,
				            max(item.SellerSKU) sellersku,
				            max(item.FulfillmentNetworkSKU) FNSKU ,
				            max(info.asin) asin,
				            max(info.name) pname,
				            max(plan.warehouseid) warehouseid,
							max(item.totaltransfee) totaltransfee,
							max(item.unittransfee) unittransfee,
							max(item.totalcost) totalcost,
							max(item.unitcost) unitcost,
							max(item.PrepOwner) PrepOwner,
							max(item.PrepInstruction) PrepInstruction,
							max(plan.shopid) shopid
					from t_erp_ship_inbounditem item
					left join t_erp_ship_inboundshipment s on s.ShipmentId=item.ShipmentId
					left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
					left join t_marketplace mk on mk.marketplaceid =plan.marketplaceid
					left join t_amazon_auth auth on auth.groupid=plan.amazongroupid and auth.aws_region=mk.aws_region
					left join t_product_info info on info.marketplaceid=mk.marketplaceid and info.sku=item.SellerSKU and info.amazonauthid=auth.id
					left join t_picture pt2 on pt2.id=info.image
					left join t_product_in_opt opt on opt.pid=info.id
					left join t_product_in_order od on od.pid=info.id
					left join t_erp_ship_inboundtrans tr on tr.shipmentid=item.shipmentid
					left join t_erp_ship_transdetail de on de.company=tr.company and de.id=tr.channel
					where item.ShipmentId  in (
		                  <foreach collection="list" item="shipmentid" index="field_list" open="" separator="," close="">
					                #{shipmentid,jdbcType=CHAR}
				          </foreach>
				        )
				       group by item.sellersku 
			) v
			left join t_erp_material m on m.sku =v.msku and v.shopid=m.shopid and m.isDelete = 0
			left join t_dimensions d on d.id=m.boxDimensions
			left join t_dimensions dim on dim.id=m.pkgDimensions
		 
		
			
			
	</select>
	 

	<select id="shipArrivalTimeChart" resultType="java.util.Map">
		select sum(ifnull(item.QuantityShipped,0)) sumship, trans.arrivalTime shopdate
		from t_erp_ship_inboundshipment inbound
		left join t_erp_ship_inboundtrans trans on trans.shipmentid=inbound.shipmentid
		left join t_erp_ship_transdetail detail on detail.id = trans.channel
		left join t_erp_ship_status stat on stat.`status`=inbound.ShipmentStatus
		left join t_erp_ship_addressto ad on ad.id=inbound.ShipToAddressID
		left join t_erp_ship_inbounditem item on item.ShipmentId=inbound.ShipmentId
		left join t_erp_ship_inboundplan form on form.id=inbound.inboundplanid
		left join t_marketplace m on m.marketplaceid=form.marketplaceid
		left join t_amazon_group g on g.id=form.amazongroupid
		where trans.arrivalTime &gt; CURDATE()
			and item.SellerSKU=#{sku,jdbcType=CHAR} 
			and form.shopid=#{shopid,jdbcType=CHAR}
			and (m.marketplaceid=#{marketplaceid,jdbcType=CHAR} or m.region=#{marketplaceid,jdbcType=CHAR}) 
			and g.id=#{groupid,jdbcType=CHAR}
		group by trans.arrivalTime
	</select>

	<select id="getshotTime" resultType="java.util.Map">
		select v.psku sku,v.marketplaceId,tsale.presales,w.stocking_cycle,
			v.openDate,v.salesweek, v.salesfifteen, v.salesmonth,v.sales,
			ifnull(ir.afn_fulfillable_quantity,0)+ifnull(rr.reserved_fc_processing,0)+ifnull(rr.reserved_fc_transfers,0) quantity 
		from (
			select p.sku psku,case when m.region='EU' then 'EU' else m.marketplaceId end marketplaceId,
			sum(s.avgsales) sales,sum(s.sales_seven) salesweek, sum(ifnull(s.sales_fifteen,0)) salesfifteen,
				sum(s.sales_month) salesmonth,min(p.openDate) openDate,a.shop_id,a.groupid,p.amazonAuthId
			from t_product_info p
			left join t_product_in_order s on p.id=s.pid
			left join t_marketplace m on m.marketplaceId=p.marketplaceid
			left join t_amazon_auth a on a.id=p.amazonAuthId
		     where a.shop_id=#{shopid,jdbcType=CHAR} and a.groupid = #{groupid,jdbcType=CHAR}
			and (m.marketplaceId = #{marketplaceid,jdbcType=CHAR} or m.region = #{marketplaceid,jdbcType=CHAR})
			and p.sku=#{sku,jdbcType=CHAR}
		    group by p.amazonAuthId,p.sku,case when m.region='EU' then 'EU' else m.marketplaceId end) v 
		left join t_erp_warehouse_fba w on w.shopid=v.shop_id and w.marketplaceid=v.marketplaceId 
		left join t_erp_estimated_sales tsale on tsale.sku=v.psku and tsale.marketplaceid = w.marketplaceid and tsale.groupid=v.groupid and tsale.isInvalid=0
		left join t_inventory_report ir on ir.marketplaceid=w.marketplaceid and ir.amazonAuthId=v.amazonAuthId and ir.sku=v.psku 
		left join t_inventory_reserved_report rr on ir.sku=rr.sku and ir.marketplaceid=rr.marketplaceid and ir.amazonAuthId=rr.amazonAuthId 
	</select>
<select id="shipmentReportByWarhouseCHType" resultType="java.util.Map">
		SELECT * FROM (
			select
		 	    plan.marketplaceid warehouse,
		 	    de.transtype,
		 	    max(mkp.name) marketname,
				max(tt.name) name,
				sum(ifnull(dd.weight,0)*item.Quantity) readweight,
				SUM(item.Quantity) totalqty,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityShipped else 0 end ) totalout,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityReceived else 0 end ) totalrec,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityReceived-item.QuantityShipped else 0 end ) lessrec,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityShipped*m.price else 0 end ) worth,
				sum(case when shipment.`status` &gt;=2 and shipment.`status`&lt;=5 then item.QuantityShipped else 0 end ) needrec,
				sum(case when shipment.`status` &gt;=2 and shipment.`status` &lt;=5 then item.Quantity-item.QuantityReceived else 0 end ) needout
			from t_erp_ship_inbounditem item
			left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
			left join t_marketplace mkp on mkp.marketplaceId=plan.marketplaceid
			left join t_erp_warehouse w on plan.warehouseid=w.id
			left join t_erp_material m on m.sku=item.SellerSKU and plan.shopid=m.shopid and m.isDelete = 0
			left join t_dimensions dd on dd.id=m.pkgDimensions
			left join t_erp_ship_inboundshipment shipment on shipment.ShipmentId=item.ShipmentId
			left join t_erp_ship_inboundtrans trans on trans.shipmentid=item.ShipmentId
			left join t_erp_ship_transdetail de on de.id=trans.channel
			left join t_erp_ship_transchannel ch on ch.id=de.channel
			left join t_erp_transtype tt on tt.id=de.transtype
			left join t_erp_ship_transcompany com on com.id=de.company
			where plan.shopid=#{param.shopid,jdbcType=CHAR} 
				and shipment.status&gt;=5 
				and com.`name` is not null
			<if test="param.datetype=='createdate'">
				and plan.createdate &gt;=#{param.fromDate,jdbcType=DATE}
				and plan.createdate &lt;=#{param.endDate,jdbcType=DATE}
			</if>
			<if test="param.datetype=='deliverydate'">
				and shipment.shiped_date &gt;=#{param.fromDate,jdbcType=DATE}
				and shipment.shiped_date &lt;=#{param.endDate,jdbcType=DATE}
			</if>
			<if test="param.warehouseid!=null">
				and w.id=#{param.warehouseid,jdbcType=CHAR}
			</if>
			<if test="param.companyid!=null">
				and de.company =#{param.companyid,jdbcType=CHAR}
			</if>
			<if test="param.channelid!=null">
				and trans.channel=#{param.channelid,jdbcType=CHAR}
			</if>
			<if test="param.search!=null">
				and item.SellerSKU  like #{param.search,jdbcType=CHAR}
			</if>
			<if test="param.groupid!=null">
				and plan.amazongroupid=#{param.groupid,jdbcType=CHAR}
			</if>
			<if test="param.marketplaceid!=null">
				and plan.marketplaceid=#{param.marketplaceid,jdbcType=CHAR}
			</if>


			 group by plan.marketplaceid,de.transtype
		) v
			left join (
				select
					plan.marketplaceid warehouse,
				    de.transtype,
					sum(case when trans.wunit='kg' then trans.transweight else 0 end) transweight_kg,
					sum(case when trans.wunit='cbm' then trans.transweight else 0 end) transweight_cbm,
					sum(ifnull(trans.singleprice,0)*ifnull(trans.transweight,0)+ifnull(trans.otherfee,0)) shipfee,
					sum(trans.otherfee) totalotherfee, count(shipment.shipmentid) shipmentnum,sum(shipment.boxnum) totalbox,
					ROUND(avg(ifnull(datediff(shipment.start_receive_date, shipment.shiped_date),0)),2) avgtime,
					count(if(shipment.status='-1',true,null )) problem
				FROM t_erp_ship_inboundshipment shipment
				left join t_erp_ship_inboundplan plan on plan.id=shipment.inboundplanid
				left join t_marketplace mkp on mkp.marketplaceid=plan.marketplaceid
				left join t_erp_warehouse w on plan.warehouseid=w.id
				left join t_erp_ship_inboundtrans trans on trans.shipmentid=shipment.ShipmentId
				left join t_erp_ship_transdetail de on de.id=trans.channel
				left join t_erp_ship_transcompany com on com.id=de.company
				where plan.shopid=#{param.shopid,jdbcType=CHAR} 
					and (shipment.status&gt;=5 or shipment.start_receive_date is not null)
					and com.`name` is not null
				<if test="param.datetype=='createdate'">
					and plan.createdate &gt;=#{param.fromDate,jdbcType=DATE}
					and plan.createdate &lt;=#{param.endDate,jdbcType=DATE}
				</if>
				<if test="param.datetype=='deliverydate'">
					and  shipment.shiped_date  &gt;=#{param.fromDate,jdbcType=DATE}
					and   shipment.shiped_date &lt;=#{param.endDate,jdbcType=DATE}
				</if>
				<if test="param.warehouseid!=null">
					and w.id=#{param.warehouseid,jdbcType=CHAR}
				</if>
				<if test="param.companyid!=null">
					and de.company =#{param.companyid,jdbcType=CHAR}
				</if>
				<if test="param.channelid!=null">
					and trans.channel=#{param.channelid,jdbcType=CHAR}
				</if>
				<if test="param.groupid!=null">
					and plan.amazongroupid=#{param.groupid,jdbcType=CHAR}
				</if>
				<if test="param.marketplaceid!=null">
					and plan.marketplaceid=#{param.marketplaceid,jdbcType=CHAR}
				</if>
			   group by plan.marketplaceid,de.transtype
			) n on v.transtype=n.transtype    and v.warehouse =n.warehouse
	</select>
	
	<select id="shipmentReportByType" resultType="java.util.Map">
		SELECT
		${param.groupby},
		max(gname) gname,
		max(market) market,
		max(company) company,
		max(logitics) logitics,
		max(channame)  channame,
		max(subarea)   subarea,
		max(channelname)  channelname,
		max(transtype) transtype,
		max(warehousename) warehousename,
		SUM(readweight) readweight,
		SUM(totalqty) totalqty,
		SUM(totalout)  totalout,
		SUM(totalrec) totalrec,
		SUM(lessrec) lessrec,
		SUM(worth) worth,
		SUM(needrec) needrec,
		SUM(needout) needout,
		sum(transweight_kg) transweight_kg,
		sum(transweight_cbm) transweight_cbm,
		sum(shipfee) shipfee,
		sum(totalbox) totalbox,
		sum(totalotherfee) totalotherfee,
		count(shipmentid) shipmentnum,
		ROUND(avg(avgtime),2) avgtime,
		SUM(problem) problem

		FROM (
			SELECT

			<if test="param.type=='nosku'">
				max(plan.amazongroupid) groupid,
				max(plan.marketplaceid) marketplaceid,
				max(plan.warehouseid) warehouseid,
				max(de.id ) channeldetailid,
				max(item.SellerSKU) sku,
				shipment.ShipmentId shipmentid,
				shipment.ShipmentId ShipmentId1,
				max(case when mkp.region='EU' then 'FBA-EU' else CONCAT('FBA-',mkp.`market`) end) warehouse,
				max(g.name) gname,
				max(mk.name) market,
				max(de.company) company,
				max(com.`name`) logitics,
				max(de.channame)  channame,
				max(de.subarea)   subarea,
				max(ch.name)  channelname,
				max(tt.name) transtype,
				max(w.name) warehousename,
				sum(ifnull(dd.weight,0)*item.Quantity) readweight,
				sum(item.Quantity) totalqty,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityShipped else 0 end)  totalout,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityReceived else 0 end)  totalrec,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityReceived-item.QuantityShipped else 0 end ) lessrec,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityShipped*m.price else 0 end)  worth,
				sum(case when shipment.`status` &gt;=2 and shipment.`status`&lt;=5 then item.QuantityShipped else 0 end ) needrec,
				sum(case when shipment.`status` &gt;=2 and shipment.`status` &lt;=5 then item.Quantity-item.QuantityReceived else 0 end)  needout
			</if>
			<if test="param.type=='sku'">
				plan.amazongroupid groupid,
				plan.marketplaceid,
				plan.warehouseid,
				de.id channeldetailid,
				item.SellerSKU sku,
				shipment.ShipmentId shipmentid,
				shipment.ShipmentId ShipmentId1,
				case when mkp.region='EU' then 'FBA-EU' else CONCAT('FBA-',mkp.`market`) end warehouse,
				g.name gname,
				mk.name market,
				de.company company,
				com.`name` logitics,
				de.channame  channame,
				de.subarea   subarea,
				ch.name  channelname,
				tt.name transtype,
				w.name warehousename,
				ifnull(dd.weight,0)*item.Quantity readweight,
				item.Quantity totalqty,
				case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityShipped else 0 end  totalout,
				case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityReceived else 0 end  totalrec,
				case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityReceived-item.QuantityShipped else 0 end  lessrec,
				case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityShipped*m.price else 0 end  worth,
				case when shipment.`status` &gt;=2 and shipment.`status`&lt;=5 then item.QuantityShipped else 0 end  needrec,
				case when shipment.`status` &gt;=2 and shipment.`status` &lt;=5 then item.Quantity-item.QuantityReceived else 0 end  needout
			</if>
			from t_erp_ship_inbounditem item
			left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
			left join t_marketplace mkp on mkp.marketplaceId=plan.marketplaceid
			left join t_erp_warehouse w on plan.warehouseid=w.id
			left join t_erp_material m on m.sku=item.SellerSKU and plan.shopid=m.shopid and m.isDelete = 0
			left join t_dimensions dd on dd.id=m.pkgDimensions
			left join t_erp_ship_inboundshipment shipment on shipment.ShipmentId=item.ShipmentId
			left join t_erp_ship_inboundtrans trans on trans.shipmentid=item.ShipmentId
			left join t_erp_ship_transdetail de on de.id=trans.channel
			left join t_erp_ship_transchannel ch on ch.id=de.channel
			left join t_erp_transtype tt on tt.id=de.transtype
			left join t_erp_ship_transcompany com on com.id=de.company
			LEFT JOIN t_amazon_group g ON g.id=plan.amazongroupid
			LEFT JOIN t_marketplace mk ON mk.marketplaceId=plan.marketplaceid
			where plan.shopid=#{param.shopid,jdbcType=CHAR}
			and shipment.status&gt;=5
			and com.`name` is not null
			<if test="param.datetype=='createdate'">
				and plan.createdate &gt;=#{param.fromDate,jdbcType=DATE}
				and plan.createdate &lt;=#{param.endDate,jdbcType=DATE}
			</if>
			<if test="param.datetype=='deliverydate'">
				and shipment.shiped_date &gt;=#{param.fromDate,jdbcType=DATE}
				and shipment.shiped_date &lt;=#{param.endDate,jdbcType=DATE}
			</if>
			<if test="param.warehouseid!=null">
				and plan.warehouseid=#{param.warehouseid,jdbcType=CHAR}
			</if>
			<if test="param.groupid!=null">
				and plan.amazongroupid=#{param.groupid,jdbcType=CHAR}
			</if>
			<if test="param.marketplaceid!=null">
				and plan.marketplaceid=#{param.marketplaceid,jdbcType=CHAR}
			</if>
			<if test="param.companyid!=null">
				and de.company =#{param.companyid,jdbcType=CHAR}
			</if>
			<if test="param.channelid!=null">
				and trans.channel=#{param.channelid,jdbcType=CHAR}
			</if>
			<if test="param.search!=null">
				and item.SellerSKU  like #{param.search,jdbcType=CHAR}
			</if>
			<if test="param.type=='nosku'">
				GROUP BY ShipmentId1
			</if>
	    ) v
		left join (
			select
			shipment.ShipmentId ShipmentId2,
			sum(case when trans.wunit='kg' then trans.transweight else 0 end) transweight_kg,
			sum(case when trans.wunit='cbm' then trans.transweight else 0 end) transweight_cbm,
			sum(ifnull(trans.singleprice,0)*ifnull(trans.transweight,0)+ifnull(trans.otherfee,0)) shipfee,
			sum(trans.otherfee) totalotherfee, count(shipment.shipmentid) shipmentnum,
			sum(ifnull(shipment.boxnum,(select count(b.id)  from t_erp_ship_v2_inboundshipment_box b
			    left join t_erp_ship_v2_inboundshipment sh on sh.shipmentid=b.shipmentid
			    where sh.shipment_confirmation_id=shipment.ShipmentId)
		   	)) totalbox,
			max(datediff(shipment.start_receive_date, shipment.shiped_date)) avgtime,
			count(if(shipment.status='-1',true,null )) problem
			FROM t_erp_ship_inboundshipment shipment
			left join t_erp_ship_inboundplan plan on plan.id=shipment.inboundplanid
			left join t_marketplace mkp on mkp.marketplaceid=plan.marketplaceid
			left join t_erp_warehouse w on plan.warehouseid=w.id
			left join t_erp_ship_inboundtrans trans on trans.shipmentid=shipment.ShipmentId
			left join t_erp_ship_transdetail de on de.id=trans.channel
			left join t_erp_ship_transcompany com on com.id=de.company
			where plan.shopid=#{param.shopid,jdbcType=CHAR}
			and (shipment.status&gt;=5 or shipment.start_receive_date is not null)
			and com.`name` is not null
			<if test="param.datetype=='createdate'">
				and plan.createdate &gt;=#{param.fromDate,jdbcType=DATE}
				and plan.createdate &lt;=#{param.endDate,jdbcType=DATE}
			</if>
			<if test="param.datetype=='deliverydate'">
				and  shipment.shiped_date  &gt;=#{param.fromDate,jdbcType=DATE}
				and   shipment.shiped_date &lt;=#{param.endDate,jdbcType=DATE}
			</if>
			<if test="param.warehouseid!=null">
				and plan.warehouseid=#{param.warehouseid,jdbcType=CHAR}
			</if>
			<if test="param.groupid!=null">
				and plan.amazongroupid=#{param.groupid,jdbcType=CHAR}
			</if>
			<if test="param.marketplaceid!=null">
				and plan.marketplaceid=#{param.marketplaceid,jdbcType=CHAR}
			</if>
			<if test="param.companyid!=null">
				and de.company =#{param.companyid,jdbcType=CHAR}
			</if>
			<if test="param.channelid!=null">
				and trans.channel=#{param.channelid,jdbcType=CHAR}
			</if>
			GROUP BY shipment.ShipmentId
		   ) n ON v.ShipmentId1 =n.ShipmentId2
		GROUP BY ${param.groupby}
	</select>

	<select id="shipmentReportByTypeTotal" resultType="java.util.Map">
		SELECT * FROM (
			select 
			    SUM(item.Quantity) totalqty,
			    sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityShipped else 0 end ) totalout,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityReceived else 0 end ) totalrec,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityReceived-item.QuantityShipped else 0 end ) lessrec,
				sum(case when shipment.`status`=5 or shipment.`status`=6 then item.QuantityShipped*m.price else 0 end ) worth,
				sum(case when shipment.`status` &gt;=2 and shipment.`status`&lt;=5 then item.QuantityShipped else 0 end ) needrec,
				sum(case when shipment.`status` &gt;=2 and shipment.`status` &lt;=5 then item.Quantity-item.QuantityReceived else 0 end ) needout,
				sum(ifnull(dd.weight,0)*item.Quantity) readweight
			from t_erp_ship_inbounditem item
			left join t_erp_ship_inboundplan plan on plan.id=item.inboundplanid
			left join t_marketplace mkp on mkp.marketplaceId=plan.marketplaceid
			left join t_erp_warehouse w on plan.warehouseid=w.id
			left join t_erp_material m on m.sku=item.SellerSKU and plan.shopid=m.shopid and m.isDelete = 0
			left join t_dimensions dd on dd.id=m.pkgDimensions
			left join t_erp_ship_inboundshipment shipment on shipment.ShipmentId=item.ShipmentId
			left join t_erp_ship_inboundtrans trans on trans.shipmentid=item.ShipmentId
			left join t_erp_ship_transdetail de on de.id=trans.channel
			left join t_erp_ship_transcompany com on com.id=de.company
			where plan.shopid=#{shopid,jdbcType=CHAR} 
				and shipment.status&gt;=5 
				and com.`name` is not null
			<if test="datetype=='createdate'">
				and  plan.createdate &gt;=#{fromDate,jdbcType=DATE}
				and  plan.createdate &lt;=#{endDate,jdbcType=DATE}
			</if>
			<if test="datetype=='deliverydate'">
				and  shipment.shiped_date &gt;=#{fromDate,jdbcType=DATE}
				and  shipment.shiped_date &lt;=#{endDate,jdbcType=DATE}
			</if>
			<if test="warehouseid!=null">
				and plan.warehouseid=#{warehouseid,jdbcType=CHAR}
			</if>
			<if test="groupid!=null">
				and plan.amazongroupid=#{groupid,jdbcType=CHAR}
			</if>
			<if test="marketplaceid!=null">
				and plan.marketplaceid=#{marketplaceid,jdbcType=CHAR}
			</if>
			<if test="companyid!=null">
				and de.company =#{companyid,jdbcType=CHAR}
			</if>
			<if test="channelid!=null">
				and trans.channel=#{channelid,jdbcType=CHAR}
			</if>
			<if test="search!=null">
				and item.SellerSKU  like #{search,jdbcType=CHAR}
			</if>
		) v
		<if test="type!='sku'">
		join (
			select sum(case when trans.wunit='kg' then trans.transweight else 0 end) transweight_kg,
				sum(case when trans.wunit='cbm' then trans.transweight else 0 end) transweight_cbm,
				sum(ifnull(trans.singleprice,0)*ifnull(trans.transweight,0)+ifnull(trans.otherfee,0)) shipfee,
				sum(trans.otherfee) totalotherfee,
				sum(ifnull(shipment.boxnum,(select count(b.id)  from t_erp_ship_v2_inboundshipment_box b
				left join t_erp_ship_v2_inboundshipment sh on sh.shipmentid=b.shipmentid
				where sh.shipment_confirmation_id=shipment.ShipmentId)
				)) totalbox,
				count(shipment.shipmentid) shipmentnum,
				ROUND(avg(ifnull(datediff(shipment.start_receive_date, shipment.shiped_date),0)),2) avgtime,
				count(if(shipment.status='-1',true,null )) problem
			FROM t_erp_ship_inboundshipment shipment
			left join t_erp_ship_inboundplan plan on plan.id=shipment.inboundplanid
			left join t_marketplace mkp on mkp.marketplaceId=plan.marketplaceid
			left join t_erp_warehouse w on plan.warehouseid=w.id
			left join t_erp_ship_inboundtrans trans on trans.shipmentid=shipment.ShipmentId
			left join t_erp_ship_transdetail de on de.id=trans.channel
			left join t_erp_ship_transcompany com on com.id=de.company
			where plan.shopid=#{shopid,jdbcType=CHAR} 
				and shipment.status&gt;=5 
				and com.`name` is not null
			<if test="datetype=='createdate'">
				and  plan.createdate &gt;=#{fromDate,jdbcType=DATE}
				and  plan.createdate &lt;=#{endDate,jdbcType=DATE}
			</if>
			<if test="datetype=='deliverydate'">
				and  shipment.shiped_date &gt;=#{fromDate,jdbcType=DATE}
				and  shipment.shiped_date &lt;=#{endDate,jdbcType=DATE}
			</if>
			<if test="warehouseid!=null">
				and plan.warehouseid=#{warehouseid,jdbcType=CHAR}
			</if>
			<if test="groupid!=null">
				and plan.amazongroupid=#{groupid,jdbcType=CHAR}
			</if>
			<if test="marketplaceid!=null">
				and plan.marketplaceid=#{marketplaceid,jdbcType=CHAR}
			</if>
			<if test="companyid!=null">
				and de.company =#{companyid,jdbcType=CHAR}
			</if>
			<if test="channelid!=null">
				and trans.channel=#{channelid,jdbcType=CHAR}
			</if>
		) n
		</if>
	</select>
	
	<update id="updateByInventoryDetail" parameterType="java.lang.String">
	    UPDATE t_erp_ship_inbounditem i 
		LEFT JOIN (SELECT referenceid,msku,sum(quantity) qty,MAX(byday) byday ,max(m.marketplaceid) marketplaceid
		from t_amz_rpt_inventory_detail d
		left join t_marketplace m on m.market=case when d.country='GB' then 'UK' else d.country end 
		WHERE eventtype='Receipts' 
		and authid=#{authid,jdbcType=CHAR}
		GROUP BY referenceid,msku) v  ON  v.referenceid=i.ShipmentId AND v.msku=i.SellerSKU
		SET i.QuantityReceived=case when i.QuantityReceived &lt; v.qty then v.qty ELSE i.QuantityReceived END ,
		i.ReceivedDate=v.byday,
		i.QuantityReceivedBalance=ifnull(case when i.QuantityReceived &lt; v.qty then v.qty ELSE i.QuantityReceived END,0)-
		ifnull(i.QuantityReceivedSub,0),
		i.marketplaceid=v.marketplaceid,
		i.amazonauthid=#{authid,jdbcType=CHAR}
		WHERE v.referenceid=i.ShipmentId AND v.msku=i.SellerSKU
	</update>

    <update id="updateByOrdersFee" parameterType="java.lang.String">
	    UPDATE t_erp_ship_inbounditem i 
		LEFT JOIN (SELECT referenceid,msku,sum(quantity) qty,MAX(byday) byday ,max(m.marketplaceid) marketplaceid
		from t_amz_rpt_orders_fulfilled_shipments_fee d
		
		WHERE  authid=#{authid,jdbcType=CHAR}
		GROUP BY referenceid,msku) v  ON  v.referenceid=i.ShipmentId AND v.msku=i.SellerSKU
		SET i.QuantityReceived=case when i.QuantityReceived &lt; v.qty then v.qty ELSE i.QuantityReceived END ,
		i.ReceivedDate=v.byday,
		i.QuantityReceivedBalance=ifnull(case when i.QuantityReceived &lt; v.qty then v.qty ELSE i.QuantityReceived END,0)-
		ifnull(i.QuantityReceivedSub,0),
		i.marketplaceid=v.marketplaceid,
		i.amazonauthid=#{authid,jdbcType=CHAR}
		WHERE v.referenceid=i.ShipmentId AND v.msku=i.SellerSKU
	</update>
	
	<update id="updateByOrderFee" parameterType="java.util.Map">
	    UPDATE t_erp_ship_inbounditem i 
		LEFT JOIN (SELECT shipmentid,sku,sum(quantity) qty
		from  t_amz_rpt_orders_fulfilled_shipments_fee
		 where amazonauthid= #{amazonauthid,jdbcType=CHAR}
		 and sku= #{sku,jdbcType=CHAR}
		 and marketplaceid=#{marketplaceid,jdbcType=CHAR}
		 and shipment_date>=#{shipmentStartDate,jdbcType=CHAR} 
		 and shipment_date&lt;#{shipmentEndDate,jdbcType=CHAR} 
		GROUP BY shipmentid,sku) v  ON  v.shipmentid=i.ShipmentId AND v.sku=i.SellerSKU
		SET  
		i.QuantityReceivedSub=ifnull(i.QuantityReceivedSub,0)-ifnull(v.qty,0),
		i.QuantityReceivedBalance= i.QuantityReceived -(ifnull(i.QuantityReceivedSub,0)-ifnull(v.qty,0))
		WHERE v.shipmentid=i.ShipmentId AND v.sku=i.SellerSKU
	</update>
	<select id="getShipinboundItemBatchCondition" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  g.name groupname,m.name marketname,s.status5date shipdate,IFNULL(pt.location,pt.url) image,
		i.SellerSKU sku,f.name ,i.`status`,p.number,s.ShipmentId shipmentid,i.QuantityShipped,i.QuantityReceived,
		st.name shipmentstatus,i.ReceivedDate,i.QuantityReceivedSub,i.unitcost,i.totalcost,i.totaltransfee,i.unittransfee,
		i.opttime,
		i.QuantityReceivedBalance,
		case when i.`status`=1 then '未开始' 
		     when i.`status`=2 then '扣减中'   
		     when i.`status`=3 then '已扣完'  
		     else '未处理' end statusname
		 from t_erp_ship_inbounditem i
		LEFT JOIN t_erp_ship_inboundshipment s ON s.ShipmentId=i.ShipmentId
		LEFT JOIN t_erp_ship_status st ON st.`status`=s.ShipmentStatus
		LEFT JOIN t_marketplace m  ON m.marketplaceId=i.marketplaceid
		LEFT JOIN t_product_info f ON f.sku=i.SellerSKU AND f.marketplaceid=i.marketplaceid AND f.amazonAuthId=i.amazonauthid
		LEFT JOIN t_erp_ship_inboundplan p ON p.id=s.inboundplanid
		LEFT JOIN t_amazon_group g ON g.id=p.amazongroupid
		LEFT JOIN t_picture pt ON pt.id=f.image
		left join t_product_in_opt opt on opt.pid=f.id
		WHERE s.`status`>=5 AND  i.ReceivedDate IS NOT NULL
		AND p.shopid=#{param.shopid,jdbcType=CHAR} 
		<if test="param.groupid!=null">
			AND p.amazongroupid=#{param.groupid,jdbcType=CHAR} 
		</if>
		<if test="param.marketplaceid!=null">
			AND p.marketplaceid=#{param.marketplaceid,jdbcType=CHAR} 
		</if>
		AND i.ReceivedDate>#{param.fromDate,jdbcType=CHAR}
		AND i.ReceivedDate &lt;=#{param.toDate,jdbcType=CHAR}
		<if test="param.search!=null">
			<if test="param.searchtype=='sku'">
				and i.SellerSKU like #{param.search,jdbcType=CHAR}
			</if>
			<if test="param.searchtype=='number'">
				and p.number like #{param.search,jdbcType=CHAR}
			</if>
			<if test="param.searchtype=='shipmentid'">
				and s.ShipmentId like #{param.search,jdbcType=CHAR}
			</if>
		</if>
		<if test="param.status!=null">
			AND i.`status`=#{param.status,jdbcType=CHAR} 
		</if>
		<if test="param.owner!=null">
			AND opt.owner=#{param.owner,jdbcType=CHAR} 
		</if>
	</select>
	<select id="findShipList" parameterType="java.util.Map" resultType="java.util.Map">
		select * from (	SELECT max(g.name) groupname,max(mk.name) marketname,
		       i.sellersku sku,max(m.name) name,max(IFNULL(pt.location,pt.url)) image
		       <foreach collection="param.fieldlist" item="fieldmap" index="field_list" open="" separator="" close="">
			               , SUM(case  when DATE_FORMAT(`status5date`, '%Y-%m') =#{fieldmap,jdbcType=CHAR} then i.QuantityShipped ELSE 0 END ) `${fieldmap}`
		       </foreach>
		FROM  t_erp_ship_inbounditem i
		LEFT JOIN t_erp_ship_inboundshipment s ON s.ShipmentId=i.ShipmentId
		LEFT JOIN t_erp_ship_inboundplan p ON p.id=s.inboundplanid
		LEFT JOIN t_product_info f ON f.sku=i.sellersku AND p.marketplaceid=f.marketplaceid AND f.amazonAuthId=i.amazonauthid
		LEFT JOIN t_amazon_group g ON g.id=p.amazongroupid
		LEFT JOIN t_marketplace mk ON mk.marketplaceId=p.marketplaceid
		LEFT JOIN t_erp_material m ON m.id=i.materialid
		LEFT JOIN t_picture pt ON pt.id=f.image
		WHERE p.shopid=#{param.shopid,jdbcType=CHAR} 
		and p.amazongroupid=#{param.groupid,jdbcType=CHAR} 
		AND s.`status`>=5 
		<if test="param.search!=null">
			and (i.sellersku like #{param.search,jdbcType=CHAR} or m.name like  #{param.search,jdbcType=CHAR} or f.name like #{param.search,jdbcType=CHAR})
		</if>
		AND  s.status5date>=CONCAT (DATE_FORMAT(CONCAT (DATE_FORMAT(DATE_ADD(CURDATE(),INTERVAL -6 MONTH), '%Y-%m'),'-01')  , '%Y-%m'),'-01')   
		AND  s.status5date&lt;CONCAT (DATE_FORMAT(DATE_ADD(CURDATE(),INTERVAL 1 MONTH), '%Y-%m'),'-01')  
		GROUP BY p.amazongroupid,p.marketplaceid,i.SellerSKU
       ) v
	</select>

	<select id="getLastShipmentQty" parameterType="java.util.Map" resultType="java.util.Map">
		select sum(shipqty) shipqty,max(shiptime) shiptime,group_concat(skushipqty) skushipqty from (
        SELECT sum(QuantityShipped) shipqty, max(s.status5date) shiptime,group_concat(concat(s.shipmentid,":",i.msku,":",i.QuantityShipped)) skushipqty
        FROM t_erp_ship_inbounditem i
        LEFT JOIN t_erp_ship_inboundshipment s ON s.ShipmentId=i.ShipmentId
        left join t_erp_ship_inboundplan p on p.id=s.inboundplanid
        WHERE p.shopid=#{shopid,jdbcType=CHAR} AND i.msku in
            ( <foreach collection="mskulist" item="itmemsku" index="field_list" open="" separator="," close="">
                 #{itmemsku,jdbcType=CHAR}
              </foreach>)
		    and s.status >=5 and s.status5date >= #{inwaretime,jdbcType=CHAR}
         union all
			SELECT  sum( ifnull(confirm_quantity,quantity)) shipqty,max(p.shipping_date) shiptime,group_concat(concat(p.number,":",i.msku,":",ifnull(i.confirm_quantity,i.quantity))) skushipqty
			FROM t_erp_ship_v2_inbounditem i
			left join t_erp_ship_v2_inboundplan p on p.id=i.formid
            WHERE p.shopid=#{shopid,jdbcType=CHAR} and p.auditstatus>=6 and p.auditstatus>=8 AND i.msku
			in (
            <foreach collection="mskulist" item="itmemsku" index="field_list" open="" separator="," close="">
              #{itmemsku,jdbcType=CHAR}
			</foreach>)
		    and  p.createtime >= #{inwaretime,jdbcType=CHAR}
	     ) v
	</select>


	<select id="getShipTimeList" parameterType="com.wimoor.amazon.inbound.pojo.dto.ShipTimeDTO" resultType="java.util.Map">
		SELECT
		i.sku sku,
		i.quantity qty,
		mt.sku msku,
		mt.name,
		w.name wname,
		g.name gname,
		m.name marketname,
		p.createtime createdate,
		s.shipment_confirmation_id shipmentid,
		p.auditime approveDate,
		v1.doneDate shipDate,
		v1.boxDate boxDate,
		v1.createDate,
		v1.pickDate,
		v1.boxDate,
		v1.placementDate,
		v1.transportationDate,
		v1.doneDate,
		v2.labelDate,
		v2.traceDate,
		v2.customsDate,
		s.shiped_date shippedDate,
		i.receiveddate receiveDate,
		s.closed_date endDate,
		ifnull(pic.location,pic.url) image,
		datediff(v1.doneDate,p.auditime) shipdays,
		datediff(s.closed_date,v1.doneDate) receivedays,
		datediff(s.closed_date,p.createtime) days,
		de.company company,
		com.`name` logitics,
		de.channame  channame,
		de.subarea   subarea,
		ch.name  channelname,
		tt.name transtype
		from t_erp_ship_v2_inboundshipment s
		LEFT JOIN t_erp_ship_v2_inboundplan p ON p.id=s.formid
		LEFT JOIN t_erp_warehouse w ON w.id=p.warehouseid
		LEFT JOIN t_erp_ship_v2_inboundshipment_item i ON i.shipmentid=s.shipmentid
		LEFT JOIN t_marketplace m ON m.marketplaceId=p.marketplaceid
		left join t_erp_ship_inboundtrans trans on trans.shipmentid=s.shipment_confirmation_id
		left join t_erp_ship_transdetail de on de.id=trans.channel
		left join t_erp_ship_transchannel ch on ch.id=de.channel
		left join t_erp_transtype tt on tt.id=de.transtype
		left join t_erp_ship_transcompany com on com.id=de.company
		LEFT JOIN t_amazon_auth a ON a.aws_region=m.aws_region AND a.groupid=p.groupid
		LEFT JOIN t_amazon_group g ON g.id=a.groupid
		LEFT JOIN (select formid,
		MAX(case when r.`status`=1 then r.opttime ELSE NULL END) createDate,
		MAX(case when r.`status`=3 then r.opttime ELSE NULL END) pickDate,
		MAX(case when r.`status`=4 OR r.`status`=6 then r.opttime ELSE NULL END) boxDate,
		MAX(case when r.`status`=5 then r.opttime ELSE NULL END) placementDate,
		MAX(case when r.`status`=7 then r.opttime ELSE NULL END) transportationDate,
		MAX(case when r.`status`=8 then r.opttime ELSE NULL END) doneDate
		from t_erp_ship_v2_inbound_record r
		where shipmentid='#'
		group by formid
		                    ) v1 on v1.formid=p.id
		LEFT JOIN (select formid,shipmentid,
		MAX(case when r.`status`=5 then r.opttime ELSE NULL END) labelDate,
		MAX(case when r.`status`=6 then r.opttime ELSE NULL END) traceDate,
		MAX(case when r.`status`=7 then r.opttime ELSE NULL END) customsDate
		from t_erp_ship_v2_inbound_record r
		where shipmentid!='#'
		group by formid,shipmentid
		) v2 on v2.formid=p.id and v2.shipmentid= s.shipment_confirmation_id
		LEFT JOIN t_product_info info ON info.amazonAuthId=a.id AND info.sku=i.sku 	AND info.marketplaceid=p.marketplaceid
		LEFT JOIN t_picture pic ON pic.id=info.image
		LEFT JOIN t_product_in_opt o ON o.pid=info.id
		LEFT JOIN t_erp_material mt ON mt.shopid=a.shop_id AND mt.sku=IFNULL(o.msku,info.sku) AND mt.isDelete=0
		WHERE p.`auditstatus`>=7 AND  p.shopid=#{param.shopid,jdbcType=CHAR}
		AND p.shipping_date>=#{param.startDate,jdbcType=TIMESTAMP}
		AND p.shipping_date &lt;=#{param.endDate,jdbcType=TIMESTAMP}
		<if test="param.groupid !=null">
			and p.groupid=#{param.groupid,jdbcType=CHAR}
		</if>
		<if test="param.marketplaceid !=null">
			and p.marketplaceid=#{param.marketplaceid,jdbcType=CHAR}
		</if>
		<if test="param.msku !=null">
			and mt.sku=#{param.msku,jdbcType=CHAR}
		</if>
		<if test="param.sku !=null">
			and i.sku=#{param.sku,jdbcType=CHAR}
		</if>

	</select>

</mapper>